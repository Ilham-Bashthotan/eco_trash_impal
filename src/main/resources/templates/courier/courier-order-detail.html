<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8" />
    <title>Detail Pesanan - Courier</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="/css/courier-style.css" rel="stylesheet" />
</head>

<body>
    <div th:replace="~{components/courier-header :: navbar}"></div>

    <div class="container">
        <div class="order-detail-container">
            <!-- Header -->
            <div class="order-header">
                <div class="order-header-title">
                    <h2>Detail Pesanan</h2>
                </div>
                <div style="text-align: right;">
                    <div class="status-row">
                        <span class="status-label">Status saat ini:</span>
                        <span class="status-badge"
                            th:classappend="${order.status.toString().toLowerCase().replace('_', '-')}"
                            th:text="${order.status}">PICKED_UP</span>
                    </div>
                    <div class="order-timestamp" style="margin-top: 10px;">
                        Order time: <strong th:text="${order.createdAt}">2025-11-24 09:45</strong>
                    </div>
                </div>
            </div>

            <!-- Order Info Section -->
            <div class="order-info-section">
                <!-- Left Column -->
                <div>
                    <div class="info-row">
                        <div class="info-label">Order ID</div>
                        <div class="info-value" th:text="${order.orderId} + ' — ' + ${order.sellerName}">ORD-1001 —
                            Alice</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Alamat</div>
                        <div class="info-value" th:text="${order.address}">Jl. Merdeka 12, Bandung</div>
                    </div>
                </div>

                <!-- Right Column - Photo -->
                <div>
                    <div class="info-label">Foto Bukti</div>
                    <div class="photo-section"
                        th:if="${order.photoProof != null and !#strings.isEmpty(order.photoProof)}">
                        <img th:src="${order.photoProof}" alt="Foto bukti"
                            style="max-width:100%; max-height:220px; object-fit:contain; border-radius:6px;" />
                    </div>
                    <div class="photo-section"
                        th:if="${order.photoProof == null or #strings.isEmpty(order.photoProof)}">
                        <div class="photo-placeholder">Foto bukti belum tersedia</div>
                    </div>
                </div>
            </div>

            <!-- Secondary Info -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="info-row">
                        <div class="info-label">Catatan</div>
                        <div class="info-value" th:text="${order.description}">Harap jangan buang sampah basah ke
                            plastik</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-row">
                        <div class="info-label">Berat Sampah (kg)</div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" class="form-control" id="trashWeight" th:value="${order.weight}"
                                placeholder="Masukkan berat sampah" step="0.1" min="0"
                                th:disabled="${order.status.toString() != 'PICKED_UP'}"
                                style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <span style="color: #999; font-size: 14px;">kg</span>
                        </div>
                        <small th:if="${order.status.toString() != 'PICKED_UP'}"
                            style="color: #ccc; margin-top: 5px; display: block;">
                            (Hanya bisa diisi saat status PICKED_UP)
                        </small>
                    </div>
                </div>
            </div>

            <!-- Alasan Pembatalan Section (jika diperlukan) -->
            <div class="reason-section" id="cancelReasonSection" style="display: none;">
                <div style="margin-bottom: 15px;">
                    <strong>Alasan pembatalan</strong>
                    <p style="font-size: 12px; color: #999; margin-top: 5px;">Catatan aksi akan memvalidasi status saat
                        ini sesuai transisi yang dizinkan.</p>
                </div>

                <label style="font-size: 12px; color: #666; margin-bottom: 8px; display: block;">
                    <strong>Pilih Alasan Pembatalan</strong>
                </label>
                <select id="cancellationReason" class="reason-dropdown">
                    <option value="">-- Pilih alasan --</option>
                    <option value="ALAMAT_TIDAK_JELAS">Alamat Tidak Jelas</option>
                    <option value="PENERIMA_TIDAK_ADA">Penerima Tidak Ada</option>
                    <option value="LOKASI_BERBAHAYA">Lokasi Berbahaya</option>
                    <option value="LAINNYA">Lainnya</option>
                </select>

                <label style="font-size: 12px; color: #666; margin: 15px 0 8px 0; display: block;">
                    <strong>Keterangan Tambahan</strong>
                </label>
                <textarea id="cancellationDetail" class="reason-textarea"
                    placeholder="Masukkan keterangan tambahan..."></textarea>
            </div>
            <!-- Action Buttons -->
            <div class="action-buttons">
                <!-- PENDING: Pickup Form -->
                <form th:if="${order.status.toString() == 'PENDING'}" method="post"
                    th:action="@{/courier/orders/{id}/pickup(id=${order.id})}" style="display: inline;">
                    <button type="submit" class="btn btn-action btn-primary-action">Setujui &amp; Ambil Pesanan</button>
                </form>

                <!-- PICKED_UP: Deliver Form with Weight -->
                <form th:if="${order.status.toString() == 'PICKED_UP'}" method="post"
                    th:action="@{/courier/orders/{id}/deliver(id=${order.id})}" style="display: inline;"
                    id="deliverForm">
                    <input type="hidden" name="weight" id="weightField" />
                    <button type="button" class="btn btn-action btn-primary-action"
                        onclick="submitDeliverForm()">Setujui &amp; Kirim</button>
                </form>

                <!-- DELIVERED: Complete Form -->
                <form th:if="${order.status.toString() == 'DELIVERED'}" method="post"
                    th:action="@{/courier/orders/{id}/complete(id=${order.id})}" style="display: inline;">
                    <button type="submit" class="btn btn-action btn-primary-action">Selesai &amp; Kembali</button>
                </form>

                <a class="btn btn-action btn-back" th:href="@{/courier/orders}">Kembali</a>
            </div>

            <script>
                function submitDeliverForm() {
                    const weightInput = document.getElementById('trashWeight');
                    const weightField = document.getElementById('weightField');
                    if (weightInput && weightInput.value) {
                        weightField.value = weightInput.value;
                    }
                    document.getElementById('deliverForm').submit();
                }
            </script>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/courier.js"></script>

    <script>
        function toggleCancelReason() {
            const cancelReasonSection = document.getElementById('cancelReasonSection');
            if (cancelReasonSection.style.display === 'none') {
                cancelReasonSection.style.display = 'block';
                cancelReasonSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                cancelReasonSection.style.display = 'none';
            }
        }
    </script>
</body>

</html>